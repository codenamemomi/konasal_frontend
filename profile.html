<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Konasal Training Institute</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap & FontAwesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="./assets/css/shared.css">
    <link rel="stylesheet" href="./assets/css/profile.css">
    <!-- JS -->
    <script src="./assets/js/navbar.js" defer></script>
    <script src="./assets/js/footer.js" defer></script>
    <script src="./assets/js/shared.js" defer></script>
</head>
<body>
    <div id="navbar"></div>

    <main>
        <!-- Profile Section -->
        <section class="profile-section">
            <div class="container">
                <div class="profile-card">
                    <h2 class="profile-title">My Profile</h2>
                    <div id="userInfo"></div>
                    <div class="profile-actions">
                        <a href="edit-profile.html" class="btn-profile">
                            <i class="fas fa-edit me-2"></i>Edit Profile
                        </a>
                        <a href="index.html" class="btn-auth">
                            <i class="fas fa-home me-2"></i>Back to Home
                        </a>
                        <a href="#" id="logoutBtn" class="btn-logout">
                            <i class="fas fa-sign-out-alt me-2"></i>Log out
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Enrolled Courses Section -->
        <section class="enrolled-courses-section">
            <div class="container">
                <h2 class="enrolled-courses-title">My Enrolled Courses</h2>
                <div id="enrolledCourses" class="row">
                    <!-- Courses will be populated dynamically or shown as empty -->
                    <p id="noCourses" class="text-center">You are not enrolled in any courses yet. <a href="course-listing.html">Explore courses</a>.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- jQuery & Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./config.js"></script>
    <script src="./assets/js/shared.js"></script>
    <script>
        // Function to get cookie value by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Debug function to check all cookies
        function debugCookies() {
            console.log('All cookies:', document.cookie);
            console.log('access_token cookie:', getCookie('access_token'));
            console.log('Is cookie sent?', document.cookie.includes('access_token'));
        }

        // Function to format date as "Month Day" (e.g., "January 15")
        function formatDateToMonthDay(dateString) {
            if (!dateString) return 'Not provided';
            
            try {
                let date;
                
                // Handle different date string formats
                if (dateString.includes('T')) {
                    // ISO format with time
                    date = new Date(dateString);
                } else if (dateString.includes('-')) {
                    // YYYY-MM-DD format
                    const [year, month, day] = dateString.split('-');
                    date = new Date(year, month - 1, day);
                } else {
                    // Try parsing as is
                    date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date:', dateString);
                    return 'Not provided';
                }
                
                // Format as "Month Day" (e.g., "January 15", "December 3")
                return date.toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Not provided';
            }
        }

        async function fetchUserProfile() {
            debugCookies(); // Debug cookies
            
            let token = getCookie('access_token');
            const useCookieAuth = !!token; // Check if cookie exists
            
            // Fallback to localStorage if no cookie
            if (!token) {
                token = localStorage.getItem('access_token');
            }

            const userInfoDiv = document.getElementById('userInfo');
            const profileActions = document.querySelector('.profile-actions');

            console.log('Using token:', token);
            console.log('Auth method:', useCookieAuth ? 'Cookie' : 'Authorization Header');

            if (!token) {
                userInfoDiv.innerHTML = `<p class="text-center">Please <a href="login.html">log in</a> to view your profile.</p>`;
                profileActions.style.display = 'none';
                return;
            }

            try {
                console.log('Making request to profile endpoint...');
                
                const requestOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (useCookieAuth) {
                    // Use cookie authentication
                    requestOptions.credentials = 'include';
                } else {
                    // Use Authorization header as fallback
                    requestOptions.headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`${API_BASE_URL}/users/profile`, requestOptions);

                console.log('Profile response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Profile error details:', errorText);
                    
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        userInfoDiv.innerHTML = `<p class="text-center">Session expired. Please <a href="login.html">log in</a> again.</p>`;
                        profileActions.style.display = 'none';
                        return;
                    }
                    throw new Error(`Failed to fetch profile: ${response.status} ${errorText}`);
                }

                const user = await response.json();
                localStorage.setItem('user', JSON.stringify(user));
                
                // Format date of birth to show only month and day
                const formattedDateOfBirth = formatDateToMonthDay(user.date_of_birth);
                
                // Build profile picture HTML if exists
                const profilePictureHTML = user.profile_picture ? 
                    `<div class="profile-picture-display">
                        <img src="${API_BASE_URL}${user.profile_picture}" alt="Profile Picture" class="profile-picture-img">
                    </div>` : 
                    '<div class="profile-picture-display no-picture">No profile picture</div>';
                
                userInfoDiv.innerHTML = `
                    ${profilePictureHTML}
                    <div class="profile-info"><label>First Name:</label> ${user.first_name}</div>
                    <div class="profile-info"><label>Last Name:</label> ${user.last_name}</div>
                    <div class="profile-info"><label>Email:</label> ${user.email}</div>
                    <div class="profile-info"><label>Phone Number:</label> ${user.phone_number || 'Not provided'}</div>
                    <div class="profile-info"><label>Gender:</label> ${user.gender || 'Not provided'}</div>
                    <div class="profile-info"><label>Date of Birth:</label> ${formattedDateOfBirth}</div>
                `;
            } catch (error) {
                console.error('Error fetching profile:', error);
                userInfoDiv.innerHTML = `<p class="text-center">Error loading profile. Please try again later.</p>`;
                profileActions.style.display = 'none';
            }
        }

        async function fetchEnrolledCourses() {
            let token = getCookie('access_token');
            const useCookieAuth = !!token; // Check if cookie exists
            
            // Fallback to localStorage if no cookie
            if (!token) {
                token = localStorage.getItem('access_token');
            }

            const enrolledCoursesDiv = document.getElementById('enrolledCourses');
            const noCourses = document.getElementById('noCourses');

            console.log('Using token for enrollments:', token);
            console.log('Auth method:', useCookieAuth ? 'Cookie' : 'Authorization Header');

            if (!token) {
                enrolledCoursesDiv.innerHTML = `<p class="text-center">Please <a href="login.html">log in</a> to view your enrolled courses.</p>`;
                noCourses.style.display = 'none';
                return;
            }

            try {
                console.log('Making request to enrollments endpoint...');
                
                const requestOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (useCookieAuth) {
                    // Use cookie authentication
                    requestOptions.credentials = 'include';
                } else {
                    // Use Authorization header as fallback
                    requestOptions.headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`${API_BASE_URL}/users/enrollments`, requestOptions);

                console.log('Enrollments response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Enrollments error details:', errorText);
                    
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        enrolledCoursesDiv.innerHTML = `<p class="text-center">Session expired. Please <a href="login.html">log in</a> again.</p>`;
                        noCourses.style.display = 'none';
                        return;
                    }
                    throw new Error('Failed to fetch enrolled courses');
                }

                const enrolledCourses = await response.json();
                if (enrolledCourses.length > 0) {
                    noCourses.style.display = 'none';
                    enrolledCoursesDiv.innerHTML = '';
                    enrolledCourses.forEach(course => {
                        enrolledCoursesDiv.innerHTML += `
                            <div class="col-md-6 col-lg-4">
                                <div class="course-card">
                                    <img src="${course.image || 'default-course.jpg'}" class="course-img" alt="${course.name}">
                                    <div class="course-body">
                                        <h5 class="course-title">${course.name}</h5>
                                        <p class="course-description">${course.summary}</p>
                                        <div class="course-meta">
                                            <span class="course-category">${course.category}</span>
                                            <span class="course-progress">Progress: ${course.progress || 0}%</span>
                                        </div>
                                        <a href="course.html?id=${course.id}">
                                            <button class="btn btn-enroll">
                                                <i class="me-2 fas fa-play-circle"></i>Continue Course
                                            </button>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    noCourses.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching enrolled courses:', error);
                enrolledCoursesDiv.innerHTML = `<p class="text-center">Error loading courses. Please try again later.</p>`;
                noCourses.style.display = 'none';
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserProfile();
            fetchEnrolledCourses();
            
            // Add logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                // Clear cookie by setting expiration to past date
                document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>